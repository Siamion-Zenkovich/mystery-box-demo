// Получаем все вопросы
const questions = document.querySelectorAll('.question__item');
var count = 1;
var intentos = 3;
var puedo = false;
var boxRoot;
// Получаем элементы, которые нужно скрыть после завершения квиза
const content1 = document.getElementById('content1');
const story = document.querySelector('.story');
const origin = document.querySelector('.origin');
const lastOrigin = document.querySelector('.origin.last');


const giftImg = document.querySelectorAll('.caja_gift-img');
const giftImgModal = document.querySelector('.gift-img-modal');
const giftImgWin = document.querySelector('.img_gift');


// Получаем блок, который нужно показать после завершения квиза
const content3 = document.getElementById('content3');

// Счетчик для отслеживания текущего вопроса
let currentQuestionIndex = 0;

// Функция для отображения текущего вопроса
function showCurrentQuestion() {
    questions.forEach((question, index) => {
        if (index === currentQuestionIndex) {
            question.style.display = 'block'; // Показываем текущий вопрос
            question.style.opacity = '1'; // Устанавливаем полную прозрачность
        } else {
            question.style.display = 'none'; // Скрываем остальные вопросы
        }
    });
}


// Функция для анимации шагов перед игрой
function animateStepsBeforeGame() {
    document.querySelector('.comments').style.display = 'none';
    document.querySelector('.accordion').style.display = 'none';
    // Показываем блок content2
    const content2 = document.getElementById('content2');
    content2.style.display = 'block';

    // Получаем элементы шагов
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');

    // Анимация первого шага
    setTimeout(() => {
        step1.classList.add('visible');
    }, 0); // Начинаем сразу

    // Анимация второго шага через 1 секунду
    setTimeout(() => {
        step2.classList.add('visible');
    }, 1000);

    // Анимация третьего шага через 2 секунды
    setTimeout(() => {
        step3.classList.add('visible');
    }, 2000);

    // Через 3 секунды (после завершения анимации шагов) включаем игру
    setTimeout(() => {
        content2.style.display = 'none'; // Скрываем блок content2
        content3.style.display = 'block'; // Показываем блок content3 с игрой
        initBoxGame(); // Инициализируем игру с коробками
    }, 3000);
}


// Функция для обработки ответа на вопрос
function handleAnswer(event) {
    if (event.target.classList.contains('question__btn')) {
        // Находим текущий вопрос
        const currentQuestion = questions[currentQuestionIndex];

        // Добавляем анимацию затухания
        currentQuestion.style.transition = 'opacity 0.2s ease-in-out'; // Плавное изменение прозрачности
        currentQuestion.style.opacity = '0'; // Затухание

        // Ждем завершения анимации (0.5 секунды), затем переходим к следующему вопросу
        setTimeout(() => {
            // Переходим к следующему вопросу
            currentQuestionIndex++;

            // Если это последний вопрос, скрываем указанные элементы и показываем анимацию шагов
            if (currentQuestionIndex === questions.length) {
                content1.style.display = 'none';
                story.style.display = 'none';
                origin.style.display = 'none';
                lastOrigin.style.display = 'none';

                // Запускаем анимацию шагов перед игрой
                animateStepsBeforeGame();
            } else {
                // Иначе показываем следующий вопрос
                showCurrentQuestion();
            }
        }, 200); // Задержка 500 мс (0.5 секунды)
    }
}

// Добавляем обработчик события на все кнопки ответа
document.querySelectorAll('.question__btn').forEach(btn => {
    btn.addEventListener('click', handleAnswer);
});

// Инициализация: показываем первый вопрос
showCurrentQuestion();

// Переменные для игры с коробками
let attempts = 0;
const maxAttempts = 3;
let canOpenBox = false;
let winningBoxIndex = null; // Выигрышная коробка будет назначена динамически

// Инициализация игры с коробками
function initBoxGame() {
    boxRoot = {
        _init: function () {
            setTimeout(function () {
                openModal('p_modal1');
            }, 500);

            document.querySelectorAll('.try').forEach(function (element) {
                element.addEventListener('click', function () {
                    if (puedo && intentos > 0) {
                        if (this.classList.contains('abierta')) {
                            return;
                        } else {
                            puedo = false;
                            this.classList.add('abierta');

                            if (count === 3) {
                                this.classList.add('premiazo');
                                setTimeout(function () {
                                    // Отображаем подарок под крышкой
                                    const giftImg = this.querySelector('.caja_gift-img');
                                    if (giftImg) {
                                        giftImg.src = './index_files/gift.webp'; // Убедитесь, что путь правильный
                                        giftImg.style.display = 'block';
                                        giftImg.style.position = 'relative';
                                        giftImg.style.zIndex = '150000';   // Показываем подарок
                                      
                                    }

                                    document.querySelector('.div_img_gift').style.display = 'block';
                                    document.querySelector('.img_gift').style.display = 'block';
                                    setTimeout(function () {
                                        openModal('p_modal3');
                                        document.querySelector('.circle-loader').classList.add('load-complete');
                                        document.querySelector('.checkmark').style.display = 'block';
                                        document.querySelector('.boxes').style.display = 'none';
                                    }, 1500);
                                }.bind(this), 1500); // Используем bind для сохранения контекста
                            } else {
                                count++;
                                intentos--;
                                document.getElementById('num_intentos').textContent = intentos;

                                setTimeout(function () {
                                    openModal('p_modal2');
                                    setTimeout(function () {
                                        document.querySelector('.circle-loader').classList.add('load-complete');
                                        document.querySelector('.checkmark').style.display = 'block';
                                        puedo = true;
                                    }, 1000);
                                }, 2000);
                            }
                        }
                    }
                });
            });

            document.getElementById('p_modal_button1').addEventListener('click', function (event) {
                event.stopPropagation();
                closeModal('p_modal1');
                puedo = true;
            });

            document.getElementById('p_modal_button2').addEventListener('click', function (event) {
                event.stopPropagation();
                closeModal('p_modal2');
            });

            document.getElementById('p_modal_button3').addEventListener('click', function (event) {
                event.stopPropagation();
                var check = document.getElementById('check');
                check.style.display = 'block';
                check.style.opacity = 0;
                check.style.transition = 'opacity 0.6s';
                setTimeout(function () {
                    check.style.opacity = 1;
                }, 10);
                closeModal('p_modal3');
                document.querySelector('.header__cart').classList.add('active');
            });
        },
    };

    boxRoot._init();
}
// Функция для обработки клика по коробке
function handleBoxClick(event) {
    if (!canOpenBox || attempts >= maxAttempts) return;

    const box = event.currentTarget;
    if (box.classList.contains('abierta')) return;

    attempts++;
    box.classList.add('abierta');

    // Если это третья попытка, назначаем текущую коробку как выигрышную
    if (attempts === maxAttempts) {
        winningBoxIndex = box.id;
        console.log("Выигрышная коробка:", winningBoxIndex); // Логируем выигрышную коробку
    }

    if (box.id == winningBoxIndex) {
        const giftImg = box.querySelector('.caja_gift');
        if (giftImg) {
            giftImg.src = 'index_files/gift.webp'; // Убедитесь, что путь правильный
            giftImg.style.display = 'block'; // Показываем подарок
            box.classList.add('premiazo'); // Добавляем класс для анимации
            console.log("Подарок отображается в коробке:", box.id); // Логируем отображение подарка
        } else {
            console.error("Элемент .caja_gift-img не найден в коробке:", box.id);
        }

        setTimeout(() => {
            document.querySelector('.div_img_gift').style.display = 'block';
            document.querySelector('.img_gift').style.display = 'block';
            openModal('p_modal3');
        }, 1500);
    } else {
        setTimeout(() => {
            openModal('p_modal2');
            document.getElementById('num_intentos').textContent = maxAttempts - attempts;
        }, 1000);
    }
}

// Функция для открытия модального окна
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.style.display = 'block';
    setTimeout(() => {
        modal.classList.add('show');
        document.body.classList.add('modal-open');
    }, 10);
}

// Функция для закрытия модального окна
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
        if (!document.querySelector('.modal.show')) {
            document.body.classList.remove('modal-open');
        }
    }, 300);
}

//DATE
var monthNames = [
    'January',
    'February',
    'March',
    'April',
    'May',
    'June',
    'July',
    'August',
    'September',
    'October',
    'November',
    'December',
];

document.addEventListener('DOMContentLoaded', function () {
    const currentDate = new Date();

    document
        .querySelectorAll('.p_var-dia')
        .forEach((el) => (el.textContent = currentDate.getDate()));
    document
        .querySelectorAll('.p_var-mes')
        .forEach((el) => (el.textContent = currentDate.getMonth()));
    document
        .querySelectorAll('.p_var-anyo')
        .forEach((el) => (el.textContent = currentDate.getFullYear()));
    document
        .querySelectorAll('.p_var-mes_nombre')
        .forEach((el) => (el.textContent = monthNames[currentDate.getMonth()]));
});

//SLIDER
('use strict');
// Инициализация Swiper
const mainSlider = new Swiper('.main-s', {
    slidesPerView: 1,
    centeredSlides: true,
    spaceBetween: 0,
    effect: 'fade',
    speed: 400,
    fadeEffect: {
        crossFade: true,
    },
    navigation: {
        nextEl: '.main-s__next',
        prevEl: '.main-s__prev',
    },
    pagination: {
        el: '.swiper-pagination',
        clickable: true,
    },
});

const subSlides = document.querySelectorAll('.first__btn');
const firstColors = document.querySelectorAll('.first__color');
const prevButton = document.querySelector('.first__prev');
const nextButton = document.querySelector('.first__next');

// Обработка кликов на кнопки выбора продукта
subSlides.forEach(function (subSlide, index) {
    subSlide.addEventListener('click', function () {
        const selectedProduct = this.getAttribute('data-product');
        const mainSlides = document.querySelectorAll('.main-s__slide');

        // Удаляем класс 'active' у всех кнопок и цветов
        subSlides.forEach(function (btn) {
            btn.classList.remove('active');
        });

        firstColors.forEach(function (firstColor) {
            firstColor.classList.remove('active');
        });

        // Добавляем класс 'active' текущей кнопке и соответствующему цвету
        this.classList.add('active');
        firstColors[index].classList.add('active');

        // Показываем только слайды, соответствующие выбранному продукту
        mainSlides.forEach(function (mainSlide) {
            if (mainSlide.getAttribute('data-product') === selectedProduct) {
                mainSlide.style.display = 'block';
            } else {
                mainSlide.style.display = 'none';
            }
        });

        // Обновляем слайдер и переходим к первому слайду
        mainSlider.update();
        mainSlider.slideTo(0);
    });
});

// Управление кнопками "Вперед" и "Назад"
prevButton.addEventListener('click', function () {
    mainSlider.slidePrev(); // Переход к предыдущему слайду
});

nextButton.addEventListener('click', function () {
    mainSlider.slideNext(); // Переход к следующему слайду
});

//NOTIFY
class Notify {
    constructor(container) {
        this.lang = {
            from: '',
        };

        this.container = document.querySelector(container);
        this.items = document.createElement('ul');
        this.items.classList.add('notifications__items');
        this.container.appendChild(this.items);
    }

    create({ title, desc, img }) {
        const item = document.createElement('li');
        item.classList.add('notifications__item', 'showNoty');
        item.innerHTML = `
			<div class="notifications__item-box">
				<div class="notifications__content">
					<h3>${title}</h3>
					<p>${desc}</p>
				</div>
				<div class="notifications__img">
					<img src="${img}" loading="eager" />
				</div>
			</div>
			<div class="notifications__btn">
				<img class="notifications__btn-close" src="index_files/notifications-close.svg" />
			</div>
		`;

        item.addEventListener('click', (e) => {
            this.removeNotification(e.currentTarget);
        });

        return item;
    }

    send(obj) {
        const item = this.create(obj);
        this.items.prepend(item);
        return item;
    }

    hide(element) {
        setTimeout(() => {
            element.classList.remove('showNoty');
            element.classList.add('hiddenNoty');
            setTimeout(() => {
                element.remove();
            }, 1000);
        }, 7000);
    }

    removeNotification(element) {
        element.classList.remove('showNoty');
        element.classList.add('hiddenNoty');
        setTimeout(() => {
            element.remove();
        }, 1000);
    }
}

const notify = new Notify('.notifications');

const randomDelay = (min, max) => Math.round(min + Math.random() * (max - min));

const showNotifications = (notifications, timeoutMs) => {
    let startTime = 0;

    notifications.forEach((el, i) => {
        const delay = i === 0 ? timeoutMs : randomDelay(40000, 70000);
        startTime += delay;

        setTimeout(() => {
            const item = notify.send(el);
            notify.hide(item);
        }, startTime);
    });
};

// showNotifications(data, 14000);

//COMMENTS
function setCookie(name, value, days) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/';
}

function getCookie(name) {
    return document.cookie.split('; ').reduce((r, v) => {
        const parts = v.split('=');
        return parts[0] === name ? decodeURIComponent(parts[1]) : r;
    }, '');
}